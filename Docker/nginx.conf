events {}

http {
    #server {
    #    listen  3000;
    #    location / {
    #        proxy_pass http://app_api:3000;
    #        #proxy_pass http://127.0.0.1:3000;
    #        proxy_set_header Host $host;
    #        proxy_set_header X-Real-IP $remote_addr;
    #        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    #        proxy_set_header X-Forwarded-Proto $scheme;
    #    }
    #}


    server {
        listen  3000;
        #listen  127.0.0.1:3000;
        proxy_set_header 'X-Fab' 'app_api-3000';
        add_header 'X-Fab' 'app_api-3000' always;

        location ~ /\.git {
          deny all;
        }  

        location / {
            proxy_pass http://app_api:3000;
            #proxy_pass http://127.0.0.1:3000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;




            if ($request_method = 'OPTIONS') {
                add_header 'Access-Control-Allow-Origin' 'http://app_web';
                add_header 'Access-Control-Allow-Methods' 'DELETE, PUT, GET, POST, OPTIONS';
                #
                # Custom headers and headers various browsers *should* be OK with but aren't
                #
                add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range';
                #
                # Tell client that this pre-flight info is valid for 20 days
                #
                add_header 'Access-Control-Max-Age' 1728000;
                add_header 'Content-Type' 'text/plain; charset=utf-8';
                add_header 'Content-Length' 0;
                return 204;
            }

            if ($request_method = 'POST') {
                add_header 'Access-Control-Allow-Origin' 'http://app_web';
                add_header 'Access-Control-Allow-Methods' 'DELETE, PUT, GET, POST, OPTIONS';
                add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range';
                add_header 'Access-Control-Expose-Headers' 'Content-Length,Content-Range';
            }

            if ($request_method = 'GET') {
                add_header 'Access-Control-Allow-Origin' 'http://app_web';
                add_header 'Access-Control-Allow-Methods' 'DELETE, GET, PUT, POST, OPTIONS';
                add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range';
                add_header 'Access-Control-Expose-Headers' 'Content-Length,Content-Range';
            }    

            if ($request_method = 'DELETE') {
                add_header 'Access-Control-Allow-Origin' 'http://app_web';
                add_header 'Access-Control-Allow-Methods' 'DELETE, GET, PUT, POST, OPTIONS';
                add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range';
                add_header 'Access-Control-Expose-Headers' 'Content-Length,Content-Range';
            }

            if ($request_method = 'PUT') {
                add_header 'Access-Control-Allow-Origin' 'http://app_web';
                add_header 'Access-Control-Allow-Methods' 'DELETE, PUT, GET, POST, OPTIONS';
                add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range';
                add_header 'Access-Control-Expose-Headers' 'Content-Length,Content-Range';
            }






        }
    }




    server {
        listen 80;

        add_header 'X-Fab' 'app_web-80' always;


        location ~ /\.git {
          deny all;
        }  





        location /api {
            proxy_pass http://app_api:3000;
        

			proxy_set_header 'X-Fab-80' 'app_api-by-web-80';

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;


           if ($request_method = 'DELETE') {
                #add_header 'Access-Control-Allow-Origin' 'http://app_web';
                add_header 'Access-Control-Allow-Methods' 'DELETE, PUT,GET, POST, OPTIONS';
                add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range';
                add_header 'Access-Control-Expose-Headers' 'Content-Length,Content-Range';
            }

            if ($request_method = 'PUT') {
                add_header 'Access-Control-Allow-Origin' 'http://app_web';
                add_header 'Access-Control-Allow-Methods' 'DELETE, PUT, GET, POST, OPTIONS';
                add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range';
                add_header 'Access-Control-Expose-Headers' 'Content-Length,Content-Range';
            }




            if ($request_method = 'OPTIONS') {
                add_header 'Access-Control-Allow-Origin' 'http://app_web';
                add_header 'Access-Control-Allow-Methods' 'DELETE, PUT, GET, POST, OPTIONS';
                #
                # Custom headers and headers various browsers *should* be OK with but aren't
                #
                add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range';
                #
                # Tell client that this pre-flight info is valid for 20 days
                #
                add_header 'Access-Control-Max-Age' 1728000;
                add_header 'Content-Type' 'text/plain; charset=utf-8';
                add_header 'Content-Length' 0;
                return 204;
            }

            if ($request_method = 'POST') {
                #add_header 'Access-Control-Allow-Origin' 'http://app_web';
                add_header 'Access-Control-Allow-Methods' 'DELETE, PUT, GET, POST, OPTIONS';
                add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range';
                add_header 'Access-Control-Expose-Headers' 'Content-Length,Content-Range';
            }

            if ($request_method = 'GET') {
                #add_header 'Access-Control-Allow-Origin' 'http://app_web';
                add_header 'Access-Control-Allow-Methods' 'DELETE, PUT, GET, POST, OPTIONS';
                add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range';
                add_header 'Access-Control-Expose-Headers' 'Content-Length,Content-Range';
            }    

    }
 


        location / {
			proxy_set_header 'X-Fab-80' 'app_web-80';
            proxy_pass http://app_web:3001;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

             if ($request_method = 'DELETE') {
                #add_header 'Access-Control-Allow-Origin' 'http://app_web';
                add_header 'Access-Control-Allow-Methods' 'DELETE, PUT, GET, POST, OPTIONS';
                add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range';
                add_header 'Access-Control-Expose-Headers' 'Content-Length,Content-Range';
            }

            if ($request_method = 'PUT') {
                add_header 'Access-Control-Allow-Origin' 'http://app_web';
                add_header 'Access-Control-Allow-Methods' 'DELETE, PUT, GET, POST, OPTIONS';
                add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range';
                add_header 'Access-Control-Expose-Headers' 'Content-Length,Content-Range';
            }

            if ($request_method = 'OPTIONS') {
                add_header 'Access-Control-Allow-Origin' 'http://app_web';
                add_header 'Access-Control-Allow-Methods' 'DELETE, PUT, GET, POST, OPTIONS';
                #
                # Custom headers and headers various browsers *should* be OK with but aren't
                #
                add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range';
                #
                # Tell client that this pre-flight info is valid for 20 days
                #
                add_header 'Access-Control-Max-Age' 1728000;
                add_header 'Content-Type' 'text/plain; charset=utf-8';
                add_header 'Content-Length' 0;
                return 204;
            }

            if ($request_method = 'POST') {
                add_header 'Access-Control-Allow-Origin' 'http://app_web';
                add_header 'Access-Control-Allow-Methods' 'DELETE, PUT, GET, POST, OPTIONS';
                add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range';
                add_header 'Access-Control-Expose-Headers' 'Content-Length,Content-Range';
            }

            if ($request_method = 'GET')  {
                #add_header 'Access-Control-Allow-Origin' 'http://app_web';
                add_header 'Access-Control-Allow-Methods' 'DELETE, PUT, GET, POST, OPTIONS';
                add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range';
                add_header 'Access-Control-Expose-Headers' 'Content-Length,Content-Range';
            }    
         }

}
}


#stream {
#
#     server {
#        listen 127.0.0.1:3306;
#        proxy_pass mysql:3306;
#    }
#
#}



